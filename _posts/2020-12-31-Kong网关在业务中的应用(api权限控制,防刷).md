---
layout:     post
title:      Kong网关在业务中的应用(api权限控制,防刷)
subtitle:   
date:       2020-12-31
author:     laosuan
header-img: 
catalog: true
tags:
    - gateway


---



前言

当我们应用的接口不需要密钥既可访问时,我们的接口容易被人抓包,数据容易被人爬取. 当我们应用的接口没有限制访问频率,手机短信验证码等成本较高的服务容易被人恶意攻击.Kong是一款开源的云原生架构下的分布式 API 网关，其性能和可扩展性在同类组件中，表现都很优异.Kong 官方提供了很多直接可用的插件,本文详细记录了kong的部署搭建过程以及使用官方插件实现api权限控制,接口访问频率限制的功能.

kong应该是有现成的rate-limiting插件https://docs.konghq.com/hub/kong-inc/rate-limiting/配置config.limit_by参数可以快速实现根据ip控制请求频率.   另外我之前有对接网店的接口,他们应该是用了HMAC Authentication插件https://docs.konghq.com/hub/kong-inc/hmac-auth/实现的接口密钥访问.前端将生成密钥的逻辑代码混淆后安全性应该是比较高的.

测试环境机器ip:

10.128.10.179

# 1 docker-copmose部署

初始化数据库:

```shell
mikdir postgres
cd postgres
git clone https://github.com/mrts/docker-postgresql-multiple-databases
docker build -t="postgresql:multi" .
docker run --name=pgtemp -e POSTGRES_PASSWORD=kong -e POSTGRES_MULTIPLE_DATABASES=kong,konga -v "$PWD/data:/var/lib/postgresql/data" postgresql:multi
#可选择检查是否在初始化时成功创建两个数据库
#docker exec -it pgtemp sh 
#psql kong kong
#postgres=# \l
docker rm -f pgtemp
```

配置docker-compose.yml:

```yaml
version: "3.7"
services:
  kong:
    image: kong:1.1.2
    environment:
     - "KONG_DATABASE=postgres"
     - "KONG_PG_HOST=kong-database"
     - "KONG_CASSANDRA_CONTACT_POINTS=kong-database"
     - "KONG_PROXY_ACCESS_LOG=/dev/stdout"
     - "KONG_ADMIN_ACCESS_LOG=/dev/stdout"
     - "KONG_PROXY_ERROR_LOG=/dev/stderr"
     - "KONG_ADMIN_ERROR_LOG=/dev/stderr"
     - "KONG_ADMIN_LISTEN=0.0.0.0:8001, 0.0.0.0:8444 ssl"
    ports:
     - 8000:8000
     - 8443:8443
     - 8001:8001
     - 8444:8444
    networks:
     - kong-net
    depends_on:
      - kong-database
  konga:
    image: pantsel/konga
    environment:
     - "TOKEN_SECRET=blueskykong.com"
     - "NODE_ENV=production"
    ports:
     - 8080:1337
    networks:
     - kong-net

    depends_on:
      - kong-database
  kong-database:
    image: postgres:9.6
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=kong
      - POSTGRES_DB=kong
    networks:
      - kong-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /data/data/postgresql:/var/lib/postgresql/data

networks:
  kong-net:
    external: false
```

启动:

```
docker-copmose up
```



# 2 konga管理UI界面

## 2.1 配置kong-admin url

浏览器打开http://{url}:1337/#!/connections

点击+NEW CONNECTIOIN按钮

name随意填:kong

kong Admin URL填:http://kong:8002

点击 UPDATE CONNECTION 按钮

再点击ACTIVE按钮



## 2.2 配置routers

## 2.3 配置services

已经docker下载docker-compose工具

# 3 开启Hmac Auth鉴权

# 4 开启Rate Limiting限频